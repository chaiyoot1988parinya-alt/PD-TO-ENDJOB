<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-size: 150%;
      font-family: sans-serif;
      margin: 10px;
      padding: 0;
    }
    h2 {
      text-align: center;
    }
    button {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      font-size: 20px;
    }
    .qr-box {
      width: 100%;
      max-width: 320px;
      margin: auto;
    }
    .form-group {
      margin: 10px 0;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 8px;
      font-size: 30px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö</h2>

  <button id="scanJobBtn">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô QR JobNo.</button>
  <div id="qr-reader-job" class="qr-box"></div>

  <div class="form-group">
    <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏à‡πä‡∏≠‡∏ö</label>
    <input id="jobNo" readonly>
  </div>
  <div class="form-group">
    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï</label>
    <input id="planQty" readonly>
  </div>
  <div class="form-group">
  <label>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Oper)</label>
  <select id="operSelect"></select>
</div>
  <button id="scanStaffBtn">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
  <div id="qr-reader-staff" class="qr-box"></div>

  <div class="form-group">
    <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
    <input id="staffCode" readonly>
  </div>
  <div class="form-group">
    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á</label>
    <input id="actualQty" type="number">
  </div>

  <button id="saveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</button>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycby_SSs8E7qTzALg_ohRjoWEoGWGHzDnPeClQyyMOSNeA3m-0RJU4gpfIZP6ziiYKrtGMA/exec'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Script URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å RP
async function fetchJobDetails(jobNo) {
  const res = await fetch(GAS_URL, {
    method: "POST",
    body: new URLSearchParams({ action:"getRPJob", jobNo })
  });
  const data = await res.json();
  if (!data.ok) {
    alert(data.msg);
    return;
  }

  rpRows = data.rows; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Oper
  const operSelect = document.getElementById("operSelect");
  operSelect.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô

  // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å Oper
  rpRows.forEach((row) => {
    const option = document.createElement("option");
    option.value = row.oper;
    option.textContent = row.oper;
    operSelect.appendChild(option);
  });

  // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  fillRPFields(rpRows[0]);
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
function fillRPFields(row) {
  document.getElementById("planQty").value = row.planQty;
  document.getElementById("staffCode").value = row.staff || "";
  document.getElementById("actualQty").value = row.actualQty || "";
  if (row.timestamp) {
    alert("‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠: " + row.timestamp);
  }
}

// ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Oper ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
document.getElementById("operSelect").addEventListener("change", () => {
  const selectedOper = document.getElementById("operSelect").value;
  const match = rpRows.find(r => r.oper === selectedOper);
  if (match) fillRPFields(match);
});


  // ‚úÖ ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  const first = data.rows[0];
  document.getElementById("planQty").value = first.planQty;
  document.getElementById("oper").value = first.oper;
  if (first.staff) document.getElementById("staffCode").value = first.staff;
  if (first.actualQty) document.getElementById("actualQty").value = first.actualQty;
  if (first.timestamp) alert("‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠: " + first.timestamp);
}


// ‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô JobNo
document.getElementById("scanJobBtn").addEventListener("click", () => {
  const qrJob = new Html5Qrcode("qr-reader-job");
  qrJob.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    (decodedText) => {
      qrJob.stop();
      const jobNo = decodedText.split("||")[0].trim(); // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡πà‡∏≠‡∏ô ||
      document.getElementById("jobNo").value = jobNo;
      fetchJobDetails(jobNo); // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    },
    (errorMessage) => { console.log(errorMessage); }
  ).catch(err => alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err));
});

// ‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
document.getElementById("scanStaffBtn").addEventListener("click", () => {
  const qrStaff = new Html5Qrcode("qr-reader-staff");
  qrStaff.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      qrStaff.stop();
      document.getElementById("staffCode").value = decodedText.split("||")[0].trim(); // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡πà‡∏≠‡∏ô ||
    },
    (errorMessage) => { console.log(errorMessage); }
  ).catch(err => alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err));
});

// ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
document.getElementById("saveBtn").addEventListener("click", async () => {
  const jobNo = document.getElementById("jobNo").value.trim();
  const oper = document.getElementById("operSelect").value;
  const staffCode = document.getElementById("staffCode").value.trim();
  const actualQty = document.getElementById("actualQty").value.trim();

  if (!jobNo || !oper || !staffCode || !actualQty) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
    return;
  }

  const res = await fetch(GAS_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "updateRPJob",
      jobNo,
      oper,
      staffCode,
      actualQty
    })
  });

  const data = await res.json();
  alert(data.msg);
});
</script>
</body>
</html>
